<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>fantasyczl</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="fantasyczl">
<meta property="og:url" content="http://fantasyczl.com/index.html">
<meta property="og:site_name" content="fantasyczl">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="fantasyczl">
<meta name="twitter:card" content="summary">
  
    <link rel="alternative" href="/atom.xml" title="fantasyczl" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
<link rel="stylesheet" href="/css/style.css">

  

<meta name="generator" content="Hexo 4.2.1"></head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">fantasyczl</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">生命是一个过程，生命的精彩在于体验</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://fantasyczl.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-20220405-go-generic-proposal" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2022/04/05/20220405-go-generic-proposal/" class="article-date">
  <time datetime="2022-04-05T10:06:04.000Z" itemprop="datePublished">2022-04-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2022/04/05/20220405-go-generic-proposal/">Golang 泛型提案学习</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>Go 1.18 支持泛型了。现在抽空就看了一下泛型提案。<a href="https://go.googlesource.com/proposal/+/refs/heads/master/design/43651-type-parameters.md" target="_blank" rel="noopener">英文地址</a><br>简单翻译如下：</p>
</blockquote>
<h1 id="翻译名词对照"><a href="#翻译名词对照" class="headerlink" title="翻译名词对照"></a>翻译名词对照</h1><ul>
<li>type =&gt; 类型</li>
<li>constrain =&gt; 结束</li>
<li>interface =&gt; interface</li>
</ul>
<h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><p>我们建议扩展Go语言，对类型和函数声明添加可选的类型参数。类型参数被 interface 类型约束。当 interface 类型被用作类型限制的时候，可以支持添加额外的元素，用来限制满足 interface 的类型的集合。参数化的类型和函数可能会使用参数的操作，但这种情况只有在所有满足参数约束的类型都允许才行。类型 interface 通过一个统一的算法进行类型推断，以允许在函数调用的时候去掉类型参数。这个设计对 Go1 完全后向兼容。</p>
<h1 id="怎么读这个提案"><a href="#怎么读这个提案" class="headerlink" title="怎么读这个提案"></a>怎么读这个提案</h1><p>这个文章非常长，这是如何阅读的指导：</p>
<ul>
<li>我们从一个高级的概述开始，非常简单的描述概念</li>
<li>然后我们从零开始解释全部的设计，介绍详情，并有简单的例子</li>
<li>在设计全部描述完之后，我们讨论实现，一些设计的问题，然后跟其它的泛型方法比较。</li>
<li>然后我用几个完整的例子，以展示这个实现在实践中是如何使用的。</li>
<li>例子之后，在附录中谈论了一些小的细节。</li>
</ul>
<h1 id="高级别的概述"><a href="#高级别的概述" class="headerlink" title="高级别的概述"></a>高级别的概述</h1><p>这部分非常简要的描述了这个设计建议的修改。这部分是为那些已经熟悉一个语言中, 泛型如何工作的人准备的。这些概念在后面的章节中会有详细的解释。</p>
<ul>
<li>函数可以有一个使用方括号的额外的类型参数列表，但是其它方面像一个普通的参数列表。<code>func F[T any](p T) {...}</code></li>
<li>这些类型参数可以被普通参数使用，也可以在函数体内使用。</li>
<li>类型也可以有类型参数列表：<code>type M[T any] []T</code>.</li>
<li>每个类型参数都有一个类型约束，就像每个普通参数都有一个类型一样：<code>func F[T Constraint](p T) {...}</code></li>
<li>类型约束是 interface 类型。</li>
<li>新的预定义的约束 <code>any</code> 是一个允许所有类型的类型约束。</li>
<li>当 interface 类型作为类型约束的时候，可以另外嵌入元素以限制满足约束的类型集合：<ul>
<li>一个任意的类型 <code>T</code> 限制只能用那个类型。</li>
<li>近似元素 <code>~T</code> 限制只能使用那些底层类型是 T 的类型。</li>
<li>联合元素 <code>T1 | T2 | ...</code> 限制只能使用列出来的类型。</li>
</ul>
</li>
<li>泛型函数使用的操作，必须被所有符合约束的类型都支持。</li>
<li>使用泛型函数或类型，必须传一个类型参数。</li>
<li>在常见情况下，类型推断允许去掉一个函数的类型参数。</li>
</ul>
<p>在接下来的部分中，我们将会对这些语言的修改详细的过一遍，你可能更想跳过开头，到例子部分，看一下实践中的泛型代码是怎么写的。</p>
<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>在 Go 中，已经有很多要求支持泛型的请求的了。在 issue traker 上也有大量的讨论。</p>
<p>这个设计建议，通过添加一种参数多态的形式，对 Go 语言进行扩展，这里的类型参数不是被声明的子类型关系限制的（就像别的面向对象语言一样），而是被明确定义的结构化约束限制。</p>
<p>这个版本的设计跟2019年7月31号的设计草稿有很多相似的地方，不过 contracts 已经去掉了，替换成了 interface 类型，并且语法也有改变。</p>
<p>针对增加类型参数，已经有几个提案了，可以通过以前的链接找到。这里呈现的很多想法之前也出现过。这里描述的主要新特性是语法和 interface 类型作为约束的仔细检查。</p>
<p>这个设计不支持模板元编程或其它任何形式的编译时编程。</p>
<p>因为术语 <code>generic</code> 在 Go 社区广泛使用，我们下面将使用它来代表一个带着类型参数的函数或类型。不要将本设计中使用的术语 generic 跟其它语言像 C++, C#, Java 或 Rust 中使用的同样的术语搞混淆。它们有相似的地方但是不一样。</p>
<h1 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h1><p>我们将分阶段基于例子来描述完整的设计。</p>
<h2 id="类型参数"><a href="#类型参数" class="headerlink" title="类型参数"></a>类型参数</h2><p>泛型代码是使用抽象的数据类型来写的，这种抽象数据类型，我们称作<strong>类型参数</strong>。当运行泛型代码的时候，类型参数将被实际参数替换。</p>
<p>这是一个函数，它输出 slice 中的每个元素，这里 slice 中元素的类型 <code>T</code> 是未知的。这是为了支持泛型编程我们想要允许的函数中，一个微不足道的例子。（稍后我们将讨论泛型类型）。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Print 输出 slice 中的元素。</span></span><br><span class="line"><span class="comment">// 它可能被传入任何类型的 slice.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Print</span><span class="params">(s []T)</span></span> &#123;  <span class="comment">// 只是一个例子，不是建议的语法</span></span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> s &#123;</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这个方法中，第一个需要做的决定是：类型参数 T 怎么被声明？在像 Go 这样的语言中，我们希望每一个标识符都以某种方式被声明。</p>
<p>这里我做一个设计决定：类型参数跟普通的非类型函数参数相似，并且跟其它参数一起列出来。然而，类型参数跟非类型参数不一样，所以虽然它们都出现在参数列表中，但是我们想要区分它们。这会导致我们下一个设计决定：我们定义一个另外的可选的参数列表来描述类型参数。</p>
<p>类型参数列表出现在普通参数前面。为了区分类型参数列表和普通参数列表，类型参数列表使用方括号而不是小圆括号。就像普通参数拥有类型，类型参数也有元类型，就是约束。我们稍后将讨论约束的细节。现在我们只需要知道 <code>any</code> 是一个有效的约束，意思是任意类型都可以。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Print 输出任意 slice 的元素。</span></span><br><span class="line"><span class="comment">// Print 有一个类型参数 T 和一个单个的普通参数 s, 它是一个 slice, slice的元素类型是 T</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Print</span>[<span class="title">T</span> <span class="title">any</span>]<span class="params">(s []T)</span></span> &#123;</span><br><span class="line">    <span class="comment">// same as above</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这就是说在 Print 函数中，标识符 T 是一个类型参数，这个类型现在还不知道，但是当函数被调用时就知道了。<code>any</code>的意思是<code>T</code>可以是任何类型。就像上面看到的，当描述普通的非类型参数时，类型参数可以被当作类型使用。在函数体中，它也可以当作类型使用。</p>
<p>跟普通参数列表不一样的是，在类型参数列表中名字是必须的。这可以避免语法歧义，并且没有任何理由去省略类型参数的名字。</p>
<p>由于 Print 有一个类型参数，所有对 Print 的调用必须提供一个类型参数。稍后我们将看到这个类型参数怎么通过非类型参数推断出来。现在我们将明确的传入类型参数。类型参数被传入，就相当于类型参数被声明了：作为一个分享的参数列表。当有类型参数列表时，使用方括号。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 []int 调用 Print.</span></span><br><span class="line"><span class="comment">// Print 有一个类型参数 T，并且我们想传入 []int，</span></span><br><span class="line"><span class="comment">// 所以我们传一个 int 类型参数，这么写 Print[int].</span></span><br><span class="line"><span class="comment">// Print[int] 函数期望参数是 []int</span></span><br><span class="line">Print[<span class="keyword">int</span>]([]<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这将会输出</span></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"><span class="comment">// 3</span></span><br></pre></td></tr></table></figure>
<h2 id="约束"><a href="#约束" class="headerlink" title="约束"></a>约束</h2><p>让我们的例子稍微复杂点。比如有一个函数，它将为了把一个任意类型的 slice 转换成 []string, 将通过调用每个元素的 String 方法来实现。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个方法是非法的。只是演示</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Stringify</span>[<span class="title">T</span> <span class="title">any</span>]<span class="params">(s []T)</span> <span class="params">(ret []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> s &#123;</span><br><span class="line">        ret = <span class="built_in">append</span>(ret, v.String())   <span class="comment">// 非法</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一眼看上去好像可以，不过这个例子中 v 的类型是 T, 而 T 可以是任何类型。这意味着 T 不需要有 String 方法。所以 v.String() 的调用是非法的。</p>
<p>当然了，同样的问题在其它支持泛型的语言中也存在。例如在 C++ 中，一个泛型函数（用C++的术语，一个函数模板）可以调用一个泛型类型的值的任意方法。就是在 C++ 中，调用 v.String() 是可以的。如果函数调用使用了一个类型参数，它没有 String 方法，编译的时候会报错。这些报错可能很长，比如在报错发生前有好几层的泛型函数调用时，为了明白哪里出错了，所有这些都需要报出来。</p>
<p>C++ 的方案对 Go 来说是个糟糕的选择。一个原因是语言的风格。在 Go 中我们不引用名字，比如，在这个例子中，String, 并且希望它们存在。当它们被看见的时候，Go 解析所有的名字到它们声明的地方。</p>
<p>另一个原因是 Go 被设计用来支持大规模编程的。我们必须考虑这个例子中泛型函数的定义（上面的 Stringify）以及对泛型函数的调用（没有显示，不过可能在其它包中）相距甚远的情况。一般来讲，所有的泛型代码期望类型参数符合某种确定的要求。我们当这种要求称作<strong>约束</strong>（其它语言有类似的概念，比如类型限制或trait限制或概念）。在这个情况，约束非常明显：类型必须有 <code>String() string</code> 方法。在别的情况中，可能没有那么明显。</p>
<p>我们不想从 Stringify 发生的地方衍生约束（在这个情况中，调用 String 方法的地方）。如果我们做了，对 Stringify 的一个小的改动可能会改变约束。那就意味着一个的改动可能影响很远的代码，调用这个函数的代码意外退出。对 Stringify 故意改变它的约束，并强制调用方改变是没有问题的。我们想要避免的是 Stringify 意外的改变了它的约束。</p>
<p>这意味着约束必须同时在调用者传入的类型参数和泛型函数中的代码中设置限制。调用者只能传满足约束的类型参数。泛型函数只能以约束允许的方式使用这些值。我们相信任何尝试在 Go 中定义泛型编程，这都是一条重要的规则：泛型代码只能使用它的类型参数知道实现了的操作。</p>
<h2 id="任意类型允许的操作"><a href="#任意类型允许的操作" class="headerlink" title="任意类型允许的操作"></a>任意类型允许的操作</h2><p>在我们讨论约束之前，我们简单的记住 <code>any</code> 约束是什么。如果一个泛型函数使用 <code>any</code> 约束，就像上面的 Print 函数一样，任意类型都允许。泛型函数中类型参数的值可以使用的操作就是那些被任意类型都允许的操作。在上面的例子中，Print 函数声明了一个变量 v 它的类型是 T，并且它把这个变量传给函数。</p>
<p>任意类型允许的操作是：</p>
<ul>
<li>声明这些类型的变量</li>
<li>把同类型的其它值你分配给这些值</li>
<li>把这些变量传给函数或者在函数返回它们</li>
<li>取这些变量的地址</li>
<li>转换或者分配这些类型的值给 interface{}</li>
<li>转换 T 类型的值到类型 T （允许但是没有用）</li>
<li>使用类型断言把一个 interace 类型的值转到这些类型</li>
<li>用在 type switch 中的 case</li>
<li>定义和使用这些类型的组合类型，比如这些类型的 slice</li>
<li>把这些类型传一些预定义的函数，比如 <code>new</code></li>
</ul>
<p>可能随着未来语言变化，可能增加其它的操作，但这不是现在可以预料的。</p>
<h3 id="定义约束"><a href="#定义约束" class="headerlink" title="定义约束"></a>定义约束</h3><p>（未完，待续…）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fantasyczl.com/2022/04/05/20220405-go-generic-proposal/" data-id="cl1lz7yno0000174i8xve9fza" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20210522-http-code-502-vs-504" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/05/22/20210522-http-code-502-vs-504/" class="article-date">
  <time datetime="2021-05-22T04:05:54.000Z" itemprop="datePublished">2021-05-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/05/22/20210522-http-code-502-vs-504/">HTTP 状态码 502 与 504 的区别</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>线上偶尔会有502或者504的报错. 我们访问网页的时候也经常会有. 那么它们到底有什么区别呢?<br>今天就查了一些资料, 来学习一下.</p>
<h2 id="先来看释义"><a href="#先来看释义" class="headerlink" title="先来看释义:"></a>先来看释义:</h2><ul>
<li>502: Bad Gateway. 表示web server 做为了一个gateway 或者 proxy 的时候, 从上游接受到了无效的 response.</li>
<li>504: Gateway Timeout. 表示web server 做为一个gateway 或者 proxy 的时候, 无法即时的从上游得到一个response, 来完成请求.</li>
</ul>
<p>看起来好像差不多. 但在实际开发中, 凭经验, 好像502, 504都是因为超时.</p>
<h2 id="LNMP-下来看一下502-504"><a href="#LNMP-下来看一下502-504" class="headerlink" title="LNMP 下来看一下502, 504"></a>LNMP 下来看一下502, 504</h2><p>下面结合 LNMP 的情形下来来看一下.</p>
<h2 id="Nginx-产生-502-的原因"><a href="#Nginx-产生-502-的原因" class="headerlink" title="Nginx 产生 502 的原因"></a>Nginx 产生 502 的原因</h2><ul>
<li>PHP-FPM 没有运行</li>
<li>Nginx 无法连接 PHP-FPM</li>
</ul>
<h3 id="PHP-FPM-没有启动"><a href="#PHP-FPM-没有启动" class="headerlink" title="PHP-FPM 没有启动"></a>PHP-FPM 没有启动</h3><p>如果因为这些原因, Nginx 无法连上 PHP-FPM, 那么将会导致 502. access.log 中:<br><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1</span> - - <span class="string">[22/May/2021:17:36:19 +0800]</span> <span class="string">"<span class="keyword">GET</span> / HTTP/1.1"</span> <span class="number">502</span> <span class="number">158</span> <span class="string">"-"</span> <span class="string">"curl/7.76.1"</span> <span class="string">"-"</span></span><br></pre></td></tr></table></figure><br>这时候 error.log 中为:<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connect() <span class="keyword">to</span> unix:/<span class="built_in">run</span>/php/php7<span class="number">.2</span>-fpm.sock failed (<span class="number">2</span>: No such <span class="built_in">file</span> <span class="keyword">or</span> directory) <span class="keyword">while</span> connecting <span class="keyword">to</span> upstream</span><br></pre></td></tr></table></figure><br>这可能是因为没有启动 PHP-FPM, 启动就好了.</p>
<h3 id="PHP-FPM-处理超时"><a href="#PHP-FPM-处理超时" class="headerlink" title="PHP-FPM 处理超时"></a>PHP-FPM 处理超时</h3><p>如果你的应用反应时间太长, 将会产生一个超时的错误. 如果 PHP-FPM 的超时设置比 Nginx 的超时设置小. Nginx 将会返回 502.<br>这是因为 PHP-FPM 关闭了连接.</p>
<p>error.log 将会显示:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">recv() failed (104:<span class="built_in"> Connection </span>reset by peer) <span class="keyword">while</span> reading response header <span class="keyword">from</span> upstream</span><br></pre></td></tr></table></figure></p>
<p>这个时候, 如果有 php-fpm 日志, 将会显示:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ARNING: [pool mypool] child 2120,<span class="built_in"> script </span><span class="string">'/var/www/html/index.php'</span> (request: <span class="string">"GET /index.php"</span>) execution timed out (25.755070 sec), terminating</span><br></pre></td></tr></table></figure></p>
<h3 id="PHP-FPM-没有超时-Nginx-超时"><a href="#PHP-FPM-没有超时-Nginx-超时" class="headerlink" title="PHP-FPM 没有超时, Nginx 超时"></a>PHP-FPM 没有超时, Nginx 超时</h3><p>如果这个时候你调高了 php-fpm 的超时时间, 这将引发另一个问题, nginx 可能会没有接收到 PHP-FPM 的响应而超时, 这个时候 Nginx 会返回 504.</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li>(502)[<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/502]" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/502]</a></li>
<li>(504)[<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/504]" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/504]</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fantasyczl.com/2021/05/22/20210522-http-code-502-vs-504/" data-id="ckozl5ein0006rm4icmu331f7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20210328-golang-cpu-too-high" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/03/28/20210328-golang-cpu-too-high/" class="article-date">
  <time datetime="2021-03-28T06:42:46.000Z" itemprop="datePublished">2021-03-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/03/28/20210328-golang-cpu-too-high/">一个Go服务占用CPU太高的优化过程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近上线一个Go服务, 在高峰期总是会报CPU超70%的报警.<br>然后就打开 pprof 开始追踪, 发现近 50% 的CPU被 runtime.gcDrain 及相关的 gc 函数占用了.</p>
<p>这说明 gc 很活跃.</p>
<p>这时候也不知道从哪里入手. 大概只有两个方向, 看一下 heap 的情况:</p>
<ol>
<li>看看哪里占的内存总多</li>
<li>看看哪里分配的对象最多</li>
</ol>
<p>最后定位到解码的函数, json 和 mapstructure.<br>仔细看了之后, 发现这里有很多直接传值的地方, 而不是传指针. 修改后, 再压测: 有改善, 但不明显.</p>
<p>这个时候就没有什么思路了.</p>
<p>经同事提醒. 再优化 elasticsearch 取数据的地方, 只取需要的 fields. 再压测, 发现有小幅提升. 但仍不明显.<br>跟同事讨论的时候, 我发现问题并不是CPU占用太高了, 而是CPU占用很高, 内存占用很少, 很不均衡. CPU占用70%, 内存不超过5%.</p>
<p>那搜索一下, 发现 Go 提供了一个 GOGC 的变量, 可以设置触发 GC 的值. 运行时也可以通过 <code>runtime/debug 包的 func SetGCPercent(percent int) int</code> 来修改.<br>默认是100, 那先修改成 500 看一下. 发现效果明显. CPU 降低了 50%.</p>
<p>问题解决了!!! 优化了一个星期, 改了很多代码. 最后是一行代码解决了!!!</p>
<p>不过目前看来 500 也有点低, 下次再调一下找一个更合理的值.</p>
<p>所以这个问题的原因是: 我们这个服务不是个CPU密集型的应用, 但是CPU占用过高, 而内存占用很低. (嗯, 只能说 Go 的 GC 很给力).<br>那这种情况下, 应该先看看, 是否可以降低触发 Gc 的阈值看一下, 也许就是你要的.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fantasyczl.com/2021/03/28/20210328-golang-cpu-too-high/" data-id="ckozl5eil0004rm4i840cdskk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Go/" rel="tag">Go</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20210218-golang-optimization" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/02/18/20210218-golang-optimization/" class="article-date">
  <time datetime="2021-02-18T08:02:36.000Z" itemprop="datePublished">2021-02-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/02/18/20210218-golang-optimization/">Go 优化Tips</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天看了一篇博客，介绍Go性能压测与pprof. 地址: <a href="https://artem.krylysov.com/blog/2017/03/13/profiling-and-optimizing-go-web-applications/" target="_blank" rel="noopener">profiling-and-optimizing-go-web-applications</a></p>
<p>其中总结的优化Tips很不错：</p>
<ol>
<li>避免不必要的 heap 申请</li>
<li>对于不大的结构体，使用值比指针更好</li>
<li>对于maps和slice, 如果提前知道大小，最好预分配大小</li>
<li>如果不是必要，就不打LOG</li>
<li>如果做很多顺序读写，使用 buffered I/O</li>
<li>如果你的应用重度使用JSON，考虑使用生成器的分析序列化工具。If your application extensively uses JSON, consider utilizing parser/serializer generators (I personally prefer easyjson).</li>
<li>热点path 的每个操作都到头重要。 Every operation matters in a hot path.</li>
</ol>
<p>原文：</p>
<ol>
<li>Avoid unnecessary heap allocations.</li>
<li>Prefer values over pointers for not big structures.</li>
<li>Preallocate maps and slices if you know the size beforehand.</li>
<li>Don’t log if you don’t have to.</li>
<li>Use buffered I/O if you do many sequential reads or writes.</li>
<li>If your application extensively uses JSON, consider utilizing parser/serializer generators (I personally prefer easyjson).</li>
<li>Every operation matters in a hot path.</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fantasyczl.com/2021/02/18/20210218-golang-optimization/" data-id="ckozl5eil0003rm4i7tce2g9q" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Go/" rel="tag">Go</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20200827-php-subpattern" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/08/27/20200827-php-subpattern/" class="article-date">
  <time datetime="2020-08-27T09:42:37.000Z" itemprop="datePublished">2020-08-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/08/27/20200827-php-subpattern/">PHP 中多个 Subpattern 匹配问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天无意中看到多个小括号嵌套的正则表达式. 突然就想, 那么匹配出来后的排序是怎么样的? 于是决定看一下文档.<br>文档地址: <a href="https://www.php.net/manual/en/regexp.reference.subpatterns.php" target="_blank" rel="noopener">https://www.php.net/manual/en/regexp.reference.subpatterns.php</a></p>
<h2 id="什么是子模式-Subpattern"><a href="#什么是子模式-Subpattern" class="headerlink" title="什么是子模式 (Subpattern)"></a>什么是子模式 (Subpattern)</h2><p>子模式通过小括号来界定. 它有两个作用:</p>
<ol>
<li>局部化一组可替代方案. 例如: (sun|mon)day, 既匹配 sunday, 也匹配 monday. 如果不用小括号的写法是 sunday|monday.</li>
<li>它建立一组可捕捉的子模式. 当整个模式匹配时, 匹配子模式的字符串通过参数传回给调用者(像 preg_match 中的 match参数). match 是个数组. 它从左到右按开括号的顺序数, (从1开始) 去获取捕捉字符串的数量.</li>
</ol>
<p>例如:<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">字符串 <span class="string">"the red king"</span> 匹配模式 ((<span class="built_in">red</span>|<span class="type">white</span>)(king|<span class="type">queen</span>)). </span><br><span class="line">捕捉子字符串就是 <span class="string">"red king"</span>, <span class="string">"red"</span>, <span class="string">"king"</span>. 下标分别是 <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span></span><br></pre></td></tr></table></figure></p>
<p>再来看一个例子:<br><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">模式是 /((Sat)ur|(Sun))day/</span><br><span class="line">匹配字符串 Saturday 的结果是, 捕捉子字符串分别是 <span class="number">1</span> =&gt; Satur, <span class="number">2</span> =&gt; Sat</span><br><span class="line">匹配字符串 Sunday 的结果是, 捕捉子字符串分别是 <span class="number">1</span> =&gt; Sun, <span class="number">2</span> =&gt; <span class="string">''</span>, <span class="number">3</span> =&gt; Sun</span><br></pre></td></tr></table></figure></p>
<p>仔细想想为什么?</p>
<h2 id="数量限制"><a href="#数量限制" class="headerlink" title="数量限制"></a>数量限制</h2><p>捕捉子字符串最多 65535 个. 不过一般不会到这个上限. 应该能满足大多数的需要.</p>
<h2 id="如何关闭捕捉子模式"><a href="#如何关闭捕捉子模式" class="headerlink" title="如何关闭捕捉子模式?"></a>如何关闭捕捉子模式?</h2><p>有的时候, 我们可能只想使用它的多组替代方案的功能(上面第1点), 而不想使用它的捕捉功能(上面第2点). 那该怎么做呢?<br>如果在左小括号后, 紧跟 “?:” 字符, 那么子模式不再时行捕捉, 并且在计算子模式的捕捉子序列时也不再计数.</p>
<p>例如:<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">((?:<span class="built_in">red</span>|<span class="type">white</span>)(king|<span class="type">queen</span>)) 匹配字符串 white queen 时,</span><br><span class="line">子模式匹配的子序列分别是: white queen, queen, 下标分别为<span class="number">1</span>,<span class="number">2</span></span><br></pre></td></tr></table></figure></p>
<h2 id="可互相替代的组号"><a href="#可互相替代的组号" class="headerlink" title="可互相替代的组号"></a>可互相替代的组号</h2><p>有时候需要有多个匹配的子模式, 但是他们的子组号可互相替代, 就是子组号要一样.<br>正常情况下, 每个子模式都会有一个后向引用的组号, 即使它们当中只有一个子模式会被匹配到.<br>解决这个问题, 需要 “?|”, 它允许产生重复的组号</p>
<p>比如:<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(?:(Sat)ur|<span class="type">(Sun</span>))day 匹配 Sunday, 子模式的匹配序列为: <span class="number">1</span> =&gt; '', <span class="number">2</span> =&gt; Sun</span><br></pre></td></tr></table></figure><br>这里 Sun 的序号是2, 即使1是空的.<br>使用 ?| 后:<br><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(?|<span class="type">(Sat</span>)ur|<span class="type">(Sun</span>))day 匹配 Sunday, 子模式的匹配序列为: <span class="number">1</span> =&gt; Sun</span><br><span class="line">(?|<span class="type">(Sat</span>)ur|<span class="type">(Sun</span>))day 匹配 Saturday, 子模式的匹配序列为: <span class="number">1</span> =&gt; Sat</span><br></pre></td></tr></table></figure></p>
<p>使用 ?| , Sat 和 Sun 的后向引用都是 1.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fantasyczl.com/2020/08/27/20200827-php-subpattern/" data-id="ckozl5eik0002rm4ie65y8e9a" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20200724-tcp-keepalive" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/07/24/20200724-tcp-keepalive/" class="article-date">
  <time datetime="2020-07-24T05:57:43.000Z" itemprop="datePublished">2020-07-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/07/24/20200724-tcp-keepalive/">Linux下如何设置 TCP KeepAlive</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-什么是-TCP-KeepAlive"><a href="#1-什么是-TCP-KeepAlive" class="headerlink" title="1. 什么是 TCP KeepAlive"></a>1. 什么是 TCP KeepAlive</h3><p>TCP KeepAlive 是一种机制, 检测 TCP 连接的另一端是否已经停止响应了</p>
<h3 id="2-怎么检测"><a href="#2-怎么检测" class="headerlink" title="2. 怎么检测"></a>2. 怎么检测</h3><p>TCP 在空闲一段时间之后, 将来发送包含null数据的检测包到另一端. 如果另一端没有响应, socket 就会自动关闭.</p>
<h3 id="3-如何设置"><a href="#3-如何设置" class="headerlink" title="3. 如何设置"></a>3. 如何设置</h3><p>TCP 的 KeepAlive 可以提高带宽的使用率. 那么在 Linux 下怎么设置呢?<br>Linux 系统可以通过 /ect/sysctl.conf 来进行设置.</p>
<p>如果想查看当前系统使用的设置是什么, 可以通过以下命令:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ls -l /proc/sys/net/ipv4/tcp_keepalive*</span><br><span class="line">-rw-r--r-- 1 root root 0 Jul 24 13:56 /proc/sys/net/ipv4/tcp_keepalive_intvl</span><br><span class="line">-rw-r--r-- 1 root root 0 Jul 24 13:56 /proc/sys/net/ipv4/tcp_keepalive_probes</span><br><span class="line">-rw-r--r-- 1 root root 0 Jul 24 13:56 /proc/sys/net/ipv4/tcp_keepalive_time</span><br><span class="line"></span><br><span class="line">cat /proc/sys/net/ipv4/tcp_keepalive*</span><br><span class="line">75</span><br><span class="line">9</span><br><span class="line">7200</span><br></pre></td></tr></table></figure></p>
<p>他们都代表什么意思呢?<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tcp_keepalive_time</span> = <span class="number">7200</span> (seconds)</span><br><span class="line"><span class="attr">tcp_keepalive_intvl</span> = <span class="number">75</span> (seconds)</span><br><span class="line"><span class="attr">tcp_keepalive_probes</span> = <span class="number">9</span> (number of probes)</span><br></pre></td></tr></table></figure></p>
<ul>
<li><ol>
<li>tcp keepalive 将会 socket 的活动后, 等待 7200 秒, 才会发送第一个 keepalive 探测.</li>
</ol>
</li>
<li><ol start="2">
<li>然后它每隔 75 秒发一次探测. 只要 TCP/IP socket 正常交流并且活跃, 就不需要 keepalive 包.</li>
</ol>
</li>
<li><ol start="3">
<li>只到9次检测都失败, 将会设为失败</li>
</ol>
</li>
</ul>
<h3 id="4-如何设置"><a href="#4-如何设置" class="headerlink" title="4. 如何设置"></a>4. 如何设置</h3><ul>
<li><ol>
<li>编辑 /ect/sysclt.conf 文件<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">vi</span> /etc/sysctl.<span class="keyword">conf</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><ol start="2">
<li>编辑或添加配置<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">net.ipv4.tcp_keepalive_time</span> = <span class="number">60</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_keepalive_intvl</span> = <span class="number">10</span></span><br><span class="line"><span class="attr">net.ipv4.tcp_keepalive_probes</span> = <span class="number">6</span></span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><ol start="3">
<li>加载配置使之生效<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sysctl -p</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fantasyczl.com/2020/07/24/20200724-tcp-keepalive/" data-id="ckozl5eij0001rm4ieuxu90us" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NetWork/" rel="tag">NetWork</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TCP/" rel="tag">TCP</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-20200606-git-rebase-merge-difference" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/06/20200606-git-rebase-merge-difference/" class="article-date">
  <time datetime="2020-06-05T16:41:04.000Z" itemprop="datePublished">2020-06-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/06/20200606-git-rebase-merge-difference/">Git rebase 与 merge 的区别</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>今天看到一篇文章, 讲到了 git rebase 与 git merge 的区别. 我觉得讲的非常好.</p>
<h3 id="功能区别"><a href="#功能区别" class="headerlink" title="功能区别"></a>功能区别</h3><h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>比如一个git项目有两个分支, master 和 feature. 当前在feature 开发. 那 feature 是从 master fork 出来的.<br>这个时候, 别人也在向 master 合并代码. 那么现在 master 和 feature 已经分叉了. 这时, 如果想让master的新提交在feature也出现.<br>有两个方法, 一是git rebase, 二是git merge.</p>
<ol>
<li>git merge. 会把 master 的内容和feature的内容合并, 并产生一个新的 commit.</li>
<li>git rebase. 会把当前feautre 分支到master的根commit到最新的commit都修改一遍. 使feature与master的分叉commit 建立在 master 的最新commit 之后. 这样产生的历史是线性的.</li>
</ol>
<h4 id="git-rebase-的注意事项"><a href="#git-rebase-的注意事项" class="headerlink" title="git rebase 的注意事项"></a>git rebase 的注意事项</h4><p>git rebase 应该永远使用在私有分支上. 因为它会修改 commit, 如果是公开的分支, 会影响别人.</p>
<p>上面没有图, 只有文字说明, 比较抽象. 具体详细的说明参见: <a href="https://www.atlassian.com/git/tutorials/merging-vs-rebasing" target="_blank" rel="noopener">https://www.atlassian.com/git/tutorials/merging-vs-rebasing</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fantasyczl.com/2020/06/06/20200606-git-rebase-merge-difference/" data-id="ckozl5eid0000rm4i7rs63qao" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Git/" rel="tag">Git</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-how-to-make-swap-mem-in-ubuntu" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/05/how-to-make-swap-mem-in-ubuntu/" class="article-date">
  <time datetime="2020-06-05T11:08:38.000Z" itemprop="datePublished">2020-06-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/05/how-to-make-swap-mem-in-ubuntu/">怎样在Ubuntu下设置交换内存</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在云主机上更新PHP的composer的时候, 一直报错, 内存不够. htop看了一下, 一共才900多M的内存, 跑了很多软件, 已经占用了700M了.<br>没办法, 不能为了软件升个级就再买CPU吧. 只好使用交换内存了.</p>
<p>记录如下:</p>
<ol>
<li><p>检查系统是否打开了交换内存. 一般没有.</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo swapon -s</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个交换文件, 用于交换, 大小自定. 我设的是物理内存的2倍. 文件地址随意.</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo fallocate -l <span class="number">2</span>G /swapfile</span><br><span class="line">chmod <span class="number">600</span> /swapfile</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在让这个文件可以用作交换内存.</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mkswap <span class="string">/swapfile</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>打开交换内存</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo swapon <span class="string">/swapfile</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>现在再检查一下交换内存是否打开(参见步骤1)</p>
</li>
<li><p>如果想要永久生效, 就是重启也有效, 需要设置 /etc/fstab 文件</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> '<span class="string">/swapfile</span> none swap sw 0 0' &gt;&gt; <span class="string">/etc/fstab</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>设置swappiness参数, 它表示在什么情况下使用交换内存. 取值在0-100之间, 表示在启用交换内存前, 物理内存空间的占比.<br>那么:</p>
</li>
</ol>
<ul>
<li>0: 表示关闭交换内存</li>
<li>1: 最小数量的交换内存, 但并不完全关闭</li>
<li>10: 比较推荐的值, 这样保证系统有足够的内存, 并且能保证性能.</li>
<li>100: 积极的使用交换内存. (没有使用过这个值)</li>
</ul>
<p>设置方法:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/sysctl.conf</span><br><span class="line"></span><br><span class="line"><span class="builtin-name">add</span> content</span><br><span class="line">vm.<span class="attribute">swappiness</span>=10</span><br></pre></td></tr></table></figure><br>exit vim, 现在使它生效.</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sudo sysctl -p</span></span><br></pre></td></tr></table></figure>
<p>到这一步, 已经完成了交换的设置.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fantasyczl.com/2020/06/05/how-to-make-swap-mem-in-ubuntu/" data-id="ckozl5eis000drm4iaf3tai82" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-what-is-the-difference-between-process-and-thread" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/06/05/what-is-the-difference-between-process-and-thread/" class="article-date">
  <time datetime="2020-06-05T11:08:12.000Z" itemprop="datePublished">2020-06-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/06/05/what-is-the-difference-between-process-and-thread/">Linux下的进程和线程有什么区别?</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>进程和线程有什么不同? 或者说有什么区别?<br>我们都知道: 进程是操作系统管理资源的最小单位, 线程是系统调度的基本单位.</p>
<p>那么具体到Linux系统, 进程和线程有什么区别呢?</p>
<p>首先, 在Linux Kernel看来, 其实是没有线程的. 所有的用户线程在在内核看来都是进程, 不过是轻量级的进程(Light Weight Process). 跟普通的进程有点区别. 区别在于:<br>轻量级进程之间共享同样的地址空间以及打开的文件等资源. 相比普通进程更轻量一些.</p>
<blockquote>
<p>So, effectively we can say that threads and light weight processes are same.<br>It’s just that thread is a term that is used at user level while light weight process is a term used at kernel level.</p>
</blockquote>
<p>实际上, 我们可以说线程和轻量级进程是一样的. 只是线程是一个用户级的术语, 而轻量级进程是一个内核级的术语.</p>
<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><p>从实现的角度来看, 线程使用 pthread 库来创建. 它内部, 使用了 clone() 的系统调用来创建轻量级进程, 像创建普通进程一样. 这意味着创建一个普通进程的 fork() 函数, 后面也会调用 clone(), 根据创建线程或轻量级进程, 使用不同的参数.</p>
<p>所以进程和线程的主要不同, 就是调用 clone() 的传参不同.</p>
<p>系统调用 clone() 克隆一个任务, 带有一个可配置的共享级别, 它们是:</p>
<ol>
<li>CLONE_FILES: 共享同样的文件描述符表(而不是创建一个新的)</li>
<li>CLONE_PARENT: 不在新任务和旧任务之间创建父子关系. 否则的话, 子进程的 getppid() = 父进程的 getpid()</li>
<li>CLONE_VM: 共享同样的内存空间, 而不是复制一份.</li>
</ol>
<p>fork() 调用 clone(), 最少的共享.<br>pthread_create() 调用 clone(), 最多的共享.</p>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><ol>
<li><a href="https://www.thegeekstuff.com/2013/11/linux-process-and-threads/" target="_blank" rel="noopener">https://www.thegeekstuff.com/2013/11/linux-process-and-threads/</a></li>
<li><a href="https://stackoverflow.com/a/809049/2550332" target="_blank" rel="noopener">https://stackoverflow.com/a/809049/2550332</a></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fantasyczl.com/2020/06/05/what-is-the-difference-between-process-and-thread/" data-id="ckozl5eiy000lrm4icfat2tso" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Process/" rel="tag">Process</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Thread/" rel="tag">Thread</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-how-to-cat-mutiplelines-to-file" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/17/how-to-cat-mutiplelines-to-file/" class="article-date">
  <time datetime="2019-12-17T11:13:11.000Z" itemprop="datePublished">2019-12-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/17/how-to-cat-mutiplelines-to-file/">命令行中向一个文件插入多行</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>命令行中向一个文件插入多行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> possibility 1:</span></span><br><span class="line">echo "line 1" &gt;&gt; greetings.txt</span><br><span class="line">echo "line 2" &gt;&gt; greetings.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> possibility 2:</span></span><br><span class="line">echo "line 1</span><br><span class="line">line 2" &gt;&gt; greetings.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> possibility 3:</span></span><br><span class="line">cat &lt;&lt;EOT &gt;&gt; greetings.txt</span><br><span class="line">line 1</span><br><span class="line">line 2</span><br><span class="line">EOT</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fantasyczl.com/2019/12/17/how-to-cat-mutiplelines-to-file/" data-id="ckozl5eir000crm4i3se274oq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Shell/" rel="tag">Shell</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/" rel="tag">Git</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Go/" rel="tag">Go</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Laravel/" rel="tag">Laravel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NetWork/" rel="tag">NetWork</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/" rel="tag">Nginx</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Process/" rel="tag">Process</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/" rel="tag">Python</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TCP/" rel="tag">TCP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Thread/" rel="tag">Thread</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vim/" rel="tag">vim</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/C/" style="font-size: 10px;">C</a> <a href="/tags/Git/" style="font-size: 13.33px;">Git</a> <a href="/tags/Go/" style="font-size: 13.33px;">Go</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/JavaScript/" style="font-size: 10px;">JavaScript</a> <a href="/tags/Laravel/" style="font-size: 10px;">Laravel</a> <a href="/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/tags/NetWork/" style="font-size: 10px;">NetWork</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/PHP/" style="font-size: 16.67px;">PHP</a> <a href="/tags/Process/" style="font-size: 10px;">Process</a> <a href="/tags/Python/" style="font-size: 13.33px;">Python</a> <a href="/tags/Shell/" style="font-size: 13.33px;">Shell</a> <a href="/tags/TCP/" style="font-size: 10px;">TCP</a> <a href="/tags/Thread/" style="font-size: 10px;">Thread</a> <a href="/tags/vim/" style="font-size: 13.33px;">vim</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/04/">四月 2022</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">五月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">三月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">二月 2021</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">八月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">六月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">九月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/04/05/20220405-go-generic-proposal/">Golang 泛型提案学习</a>
          </li>
        
          <li>
            <a href="/2021/05/22/20210522-http-code-502-vs-504/">HTTP 状态码 502 与 504 的区别</a>
          </li>
        
          <li>
            <a href="/2021/03/28/20210328-golang-cpu-too-high/">一个Go服务占用CPU太高的优化过程</a>
          </li>
        
          <li>
            <a href="/2021/02/18/20210218-golang-optimization/">Go 优化Tips</a>
          </li>
        
          <li>
            <a href="/2020/08/27/20200827-php-subpattern/">PHP 中多个 Subpattern 匹配问题</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 fantasyczl<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>


  </div>
</body>
</html>